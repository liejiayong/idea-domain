(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{691:function(t,s,a){"use strict";a.r(s);var n=a(9),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("blockquote",[a("p",[t._v("持续更新...")])]),t._v(" "),a("h1",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("在日常开发过程中，现在已经是第二次碰见华为手机在 APP 内置 WebView 上浏览图片出现图片不显示的问题了，在 wap 端是不存在这个问题的。还记得第一次碰见这个问题的时候是在与移动端开发人员探讨图片不显示 bug，排除了样式、图片因素和 js 干扰后，最后将矛头指向 WebView 加载问题，然后移动端开发人员在查阅 WebView 文档后指出是 WebView 模式引起的。作为一名专业的螺丝钉制造者，有必要将问题总结下来，让大家少踩坑~")]),t._v(" "),a("h1",{attrs:{id:"webview-的模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#webview-的模式"}},[t._v("#")]),t._v(" WebView 的模式")]),t._v(" "),a("ul",[a("li",[t._v("Android@version < v5.0，默认是采用的 MIXED_CONTENT_ALWAYS_ALLOW 模式，即总是允许 WebView 同时加载 Https 和 Http；")]),t._v(" "),a("li",[t._v("Android@version >= v5.0，默认用 MIXED_CONTENT_NEVER_ALLOW 模式，即总是不允许 WebView 同时加载 Https 和 Http。")])]),t._v(" "),a("p",[t._v("安全问题一直都是值得开发者探讨的问题，开发者本应对每个微小细节把关，保护好每一份数据。从 Android 5.0 开始，WebView 默认是采用的 MIXED_CONTENT_NEVER_ALLOW 模式，不再支持同时加载 Https 和 Http 混合模式。这主要处于对网络数据安全性的考虑，官方默认推荐使用 https。对于需要修改模型的，可以自行修改配置，不过实测在一些机型如华为 P30，WebView 使用混合 http 和 https 也不是万全之策，况且在规范上应尽量保持只用 http 或只用 https 为妙。")]),t._v(" "),a("h2",{attrs:{id:"mixed-content-never-allow"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mixed-content-never-allow"}},[t._v("#")]),t._v(" "),a("code",[t._v("MIXED_CONTENT_NEVER_ALLOW")])]),t._v(" "),a("p",[t._v("此模式要求 WebView 使用 https 加载资源。WebView "),a("code",[t._v("不允许")]),t._v("一个安全的站点（https）去"),a("code",[t._v("加载非安全")]),t._v("的站点内容（http）,比如，https 网页内容的图片是 http 链接。强烈建议 App 使用这种模式，因为这样"),a("code",[t._v("更安全")]),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"mixed-content-always-allow"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mixed-content-always-allow"}},[t._v("#")]),t._v(" "),a("code",[t._v("MIXED_CONTENT_ALWAYS_ALLOW")])]),t._v(" "),a("p",[t._v("允许 https 环境加载 http 资源，不安全。此模式下 WebView 是可以在一个安全的站点（Https）里加载非安全的站点内容（Http）,这是 WebView "),a("code",[t._v("最不安全")]),t._v("的操作模式，尽可能地"),a("code",[t._v("不要使用")]),t._v("这种模式。")]),t._v(" "),a("h2",{attrs:{id:"mixed-content-compatibility-mode"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mixed-content-compatibility-mode"}},[t._v("#")]),t._v(" "),a("code",[t._v("MIXED_CONTENT_COMPATIBILITY_MODE")])]),t._v(" "),a("p",[t._v("允许 https 环境兼容式阻塞加载 http 资源，较安全。此模式下，当涉及到混合式内容时，WebView 会尝试去"),a("code",[t._v("兼容")]),t._v("最新 Web 浏览器的风格。一些不安全的内容（Http）能被加载到一个安全的站点上（Https），而其他类型的内容将"),a("code",[t._v("会被阻塞")]),t._v("。这些内容的类型是被允许加载还是被阻塞可能会随着版本的不同而改变，并没有明确的定义。这种模式主要用于在 App 里面不能控制内容的渲染，但是又希望在一个安全的环境下运行。")]),t._v(" "),a("h1",{attrs:{id:"实战情景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实战情景"}},[t._v("#")]),t._v(" 实战情景")]),t._v(" "),a("h2",{attrs:{id:"华为-p30-app-内置-webview-环境加载图片不显示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#华为-p30-app-内置-webview-环境加载图片不显示"}},[t._v("#")]),t._v(" 华为 P30 App 内置 WebView 环境加载图片不显示")]),t._v(" "),a("ul",[a("li",[t._v("测试环境\n"),a("ul",[a("li",[t._v("运行终端：app 内置 WebView 环境")]),t._v(" "),a("li",[t._v("手机型号：华为 P30")]),t._v(" "),a("li",[t._v("os：Android 9.0")])])])]),t._v(" "),a("p",[t._v("对于这个图片加载不显示的问题做了几个尝试：")]),t._v(" "),a("ul",[a("li",[t._v("在不修改原本加载资源的情况下，使用混合模式"),a("code",[t._v("MIXED_CONTENT_COMPATIBILITY_MODE")]),t._v("尝试加载资源")])]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*app启用WebView混合模式尝试解决图片不显示*/")]),t._v("\nwebSetting"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setBlockNetworkImage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不阻塞网络图片")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VERSION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SDK_INT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" Build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VERSION_CODES")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LOLLIPOP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//允许混合（http，https）")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//webSetting.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);")]),t._v("\n  webSetting"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setMixedContentMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("WebSettings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MIXED_CONTENT_COMPATIBILITY_MODE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("在设置好混合模式后来了一波测试，本以为顺利搞掂，最后杀出一个程咬金说有些图片不够"),a("code",[t._v("s")]),t._v("，所以不见得能显示出来(；д；)。")]),t._v(" "),a("p",[t._v("啊不，是因为有些图片没有安全证书问题显示不出来。ヾ(ｏ･ω･)ﾉ")]),t._v(" "),a("p",[t._v("蓦然回首，发现在这个 https 安全环境的问题还是挺多的呀，有些机型加载 http 资源没有安全证还是不让显示的。有安全证书保平安呐！混合模式并不是万能的！")]),t._v(" "),a("p",[t._v("回到问题，当 WebView 加载网页发生证书认证错误时，会调用 WebViewClient 类的 onReceivedSslError 方法，在这个方法里，可以点击源码看到 SslErrorHandler 中有两个主要的方法可以调用：")]),t._v(" "),a("ul",[a("li",[t._v("cancel()：停止加载问题页面")]),t._v(" "),a("li",[t._v("proceed()：忽略 SSL 证书错误，继续加载页面")])]),t._v(" "),a("p",[t._v("如果不考虑证书安全，则可以这样忽略报错：")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebView")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setWebViewClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebViewClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onReceivedSslError")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebView")]),t._v(" view"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SslErrorHandler")]),t._v(" handler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SslError")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  handler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("proceed")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//接受所有网站的证书")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("然后对于不显示的图片，只能让后台手动修改链接，改为对应的 https 什么的。")]),t._v(" "),a("p",[t._v("另外，在测试时发现 X5 内核的 WebView 中，是找不到 MIXED_CONTENT_ALWAYS_ALLOW 这些模式参数的，对此要手动判断是否 X5 并设值：")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MIXED_CONTENT_NEVER_ALLOW")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MIXED_CONTENT_ALWAYS_ALLOW")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MIXED_CONTENT_COMPATIBILITY_MODE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VERSION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("SDK_INT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" Build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VERSION_CODES")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("LOLLIPOP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 混合模式")]),t._v("\n  webSetting"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setMixedContentMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("测试至此，本人对混合模式是持谨慎态度的，不太建议使用，除非迫不得已的情况吧。")]),t._v(" "),a("p",[t._v("从规范上来讲，要么全部使用 http 的资源，要么全部使用 https。")]),t._v(" "),a("ul",[a("li",[t._v("最后推荐全部资源使用 https")]),t._v(" "),a("li",[t._v("对于爱偷懒的我来讲(～￣ ▽ ￣)～ ，更喜欢这种格式书写："),a("code",[t._v("//www.xxx.com/")])])]),t._v(" "),a("h1",{attrs:{id:"参考文档"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[t._v("#")]),t._v(" 参考文档")]),t._v(" "),a("ul",[a("li",[a("p",[a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content",target:"_blank",rel:"noopener noreferrer"}},[t._v("MDN-Mixed content"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://developer.android.com/reference/android/webkit/WebSettings.html#setMixedContentMode(int)",target:"_blank",rel:"noopener noreferrer"}},[t._v("Google developer WebSettings Docs"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/tNoRee8nW-nuY7e8DAFk1Q",target:"_blank",rel:"noopener noreferrer"}},[t._v("从华为 P30 图片不显示谈 WebView 的资源加载模式"),a("OutboundLink")],1)])])])])}),[],!1,null,null,null);s.default=e.exports}}]);